<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
    </style>
  </head>
  <body>
    <canvas id='painting' width='1024' height='768' style='border: solid 3px red'></canvas>
    <script src='/socket.io/socket.io.js'></script>
    <!-- <script src='//code.jquery.com/jquery-3.1.1.slim.min.js'></script> -->
    <script>
      var socket = io()
      var painting = document.getElementById('painting')
      var ctx = painting.getContext('2d')
      var strokes = []
      var brush = { down: false, x: 0, y: 0 }

      painting.addEventListener('mousedown', (e) => {
        Object.assign(brush, { down: true, x: e.clientX, y: e.clientY})
      })
      painting.addEventListener('mouseup', (e) => {
        Object.assign(brush, { down: false })
      })
      painting.addEventListener('mouseleave', (e) => {
        Object.assign(brush, { down: false })
      })
      painting.addEventListener('mousemove', (e) => {
        if (!brush.down) return
        strokes.push({ x0: brush.x, y0: brush.y, x1: e.clientX, y1: e.clientY })
        Object.assign(brush, { x: e.clientX, y: e.clientY })
      })
      window.addEventListener('resize', resize)
      socket.addEventListener('paint', paint)

      resize()
      setInterval(transmit, 50)

      function paint(color, segments) {
        ctx.lineWidth = 5
        ctx.strokeStyle = color
        ctx.beginPath()
        segments.forEach((segment, i) => {
          ctx.moveTo(segment.x0, segment.y0)
          ctx.lineTo(segment.x1, segment.y1)
        })
        ctx.stroke()
      }

      function resize() {
        painting.width = window.innerWidth
        painting.height = window.innerHeight
      }

      function transmit() {
        if (!strokes.length) return
        socket.emit('strokes', strokes)
        strokes = []
      }
    </script>
  </body>
</html>
